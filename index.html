<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.hackerzzp.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="HelloWorldMan">
<meta property="og:type" content="website">
<meta property="og:title" content="ZpZeng&#39;s Blog">
<meta property="og:url" content="http://www.hackerzzp.top/index.html">
<meta property="og:site_name" content="ZpZeng&#39;s Blog">
<meta property="og:description" content="HelloWorldMan">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zp Zeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.hackerzzp.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>ZpZeng's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZpZeng's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.hackerzzp.top/2023/11/14/pytorch-2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://gips2.baidu.com/it/u=3498797510,1741357035&fm=3039&app=3039&f=JPEG?w=1024&h=1024">
      <meta itemprop="name" content="Zp Zeng">
      <meta itemprop="description" content="HelloWorldMan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZpZeng's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/14/pytorch-2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">pytorch-2 神经网络搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-11-14 09:17:05 / 修改时间：09:18:16" itemprop="dateCreated datePublished" datetime="2023-11-14T09:17:05+08:00">2023-11-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文梳理利用pytorch实现神经网络的具体流程。</p>
<h2 id="读取数据集"><a href="#读取数据集" class="headerlink" title="读取数据集"></a>读取数据集</h2><h3 id="torch-utils-data-TensorDataset"><a href="#torch-utils-data-TensorDataset" class="headerlink" title="torch.utils.data.TensorDataset()"></a>torch.utils.data.TensorDataset()</h3><p>这个函数将多个张量作为输入，将它们按dim=0维度打包成为一个数据集对象，即把每个样本的特征和标签打包到一起。因此要求输入的各个张量的dim=0维度长度相同。返回一个torch.utils.data.Dataset类的对象。</p>
<h3 id="torch-utils-data-Dataset"><a href="#torch-utils-data-Dataset" class="headerlink" title="torch.utils.data.Dataset"></a>torch.utils.data.Dataset</h3><p>同样，也可以继承Dataset类形成自己的My_Dataset类。需要实现以下两个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">My_Dataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,...</span>): </span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># 注意,在初始化中，可以进行对数据的处理,如:预处理和数据转换等</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 返回数据集的长度</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="comment"># 返回索引对应的样本数据</span></span><br></pre></td></tr></table></figure>
<h3 id="torch-utils-data-DataLoader"><a href="#torch-utils-data-DataLoader" class="headerlink" title="torch.utils.data.DataLoader()"></a>torch.utils.data.DataLoader()</h3><p>这个函数可以实现按批次的高效率迭代器：批量加载数据、数据洗牌、通过num_workers支持多线程加载数据、通过torchvision.transforms提供数据预处理以及转换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils <span class="keyword">import</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设已经有features, labels数据集代表样本的特征和标签,注意它们的dim=0维度上的长度是一样的,代表样本数量</span></span><br><span class="line">dataset = data.TensorDataset(*(features, labels))</span><br><span class="line">data_iter = data.DataLoader(dataset, batch_size, shuffle=is_train)</span><br><span class="line"><span class="built_in">next</span>(<span class="built_in">iter</span>(data_iter))</span><br></pre></td></tr></table></figure>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><h3 id="torch-nn-Sequential"><a href="#torch-nn-Sequential" class="headerlink" title="torch.nn.Sequential"></a>torch.nn.Sequential</h3><p>Sequential类可以用于实现一个神经网络模型，它将多个层串联在一起以实现深层网络net(model)。</p>
<p>可以通过索引选取Sequential对象中的某一层网络。</p>
<p>当然，也可以通过继承<strong>torch.nn.Module实现一个网络类</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">My_Model</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Model, self).__init__()</span><br><span class="line">        <span class="comment"># 在此实现该模型中需要用到的层的定义</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># 利用上面实现的层搭建神经网络，通过实现前向传播定义网络。</span></span><br></pre></td></tr></table></figure>
<h2 id="初始化模型参数"><a href="#初始化模型参数" class="headerlink" title="初始化模型参数"></a>初始化模型参数</h2><p>通过Sequential定义的模型，可以通过索引选取某一层，通过isinstance()判断是哪一种nn层的实例，通过torch.nn.init选取合适的方法初始化。</p>
<p>通过继承nn.Module自定义网络模型，可以在__init__()函数中利用torch.nn.init定义初始化模型参数的策略。</p>
<h2 id="定义损失函数"><a href="#定义损失函数" class="headerlink" title="定义损失函数"></a>定义损失函数</h2><p>使用torch.nn中自带的神经网络损失函数，如：均方损失、交叉熵损失等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line">loss = nn.MSELoss()</span><br><span class="line"><span class="comment"># 输入标签的预测值和真实值，返回损失函数</span></span><br></pre></td></tr></table></figure>
<h2 id="定义优化器"><a href="#定义优化器" class="headerlink" title="定义优化器"></a>定义优化器</h2><p>利用torch.optim中提供的优化函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">optimer = torch.optim.SGD(net.parameters(), lr=<span class="number">0.03</span>)</span><br><span class="line"><span class="comment"># 该函数以模型参数和学习步长作为输入，通过optimer.zero_grad()和optimer.step()来清零原梯度，并做一次梯度下降步骤</span></span><br></pre></td></tr></table></figure>
<h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2><p>epochs控制训练轮次。batch_size控制批量大小，在dataLoader中实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">    <span class="keyword">for</span> X, y <span class="keyword">in</span> data_iter:</span><br><span class="line">        l = loss(net(X), y)</span><br><span class="line">        <span class="comment"># 计算在该批量上的损失</span></span><br><span class="line">        optimer.zero_grad()</span><br><span class="line">        <span class="comment"># 使用优化器将网络参数的梯度归零</span></span><br><span class="line">        l.backward()</span><br><span class="line">        <span class="comment"># 损失函数上反向传播</span></span><br><span class="line">        optimer.step()</span><br><span class="line">        <span class="comment"># 使用优化器在网络参数上做一次梯度下降步骤</span></span><br><span class="line">    l = loss(net(features), labels)</span><br><span class="line">    <span class="comment"># 在每个epoch后计算一次当前模型在整个数据样本集上的损失</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.hackerzzp.top/2023/11/13/pytorch-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://gips2.baidu.com/it/u=3498797510,1741357035&fm=3039&app=3039&f=JPEG?w=1024&h=1024">
      <meta itemprop="name" content="Zp Zeng">
      <meta itemprop="description" content="HelloWorldMan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZpZeng's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/13/pytorch-1/" class="post-title-link" itemprop="url">pytorch-1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-13 16:37:12" itemprop="dateCreated datePublished" datetime="2023-11-13T16:37:12+08:00">2023-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-14 00:00:27" itemprop="dateModified" datetime="2023-11-14T00:00:27+08:00">2023-11-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="原地操作"><a href="#原地操作" class="headerlink" title="原地操作"></a>原地操作</h2><ol>
<li>使用x += x + y或者 x[:] = a + b可以进行原地操作，即操作之后x的内存不会改变</li>
<li>torch.Tensor.numpy()可以将Tensor对象转变为ndarray，但这两个对象共享底层内存</li>
<li>torch.Tensor对象有些以下划线结尾的函数实现原地操作，如：normal_()、fill_()等。</li>
</ol>
<h2 id="数据预处理的一些函数"><a href="#数据预处理的一些函数" class="headerlink" title="数据预处理的一些函数"></a>数据预处理的一些函数</h2><p>pandas</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">pd.DataFrame.iloc[ , ] </span><br><span class="line"><span class="comment">#DataFrame对象的entry</span></span><br><span class="line">pd.DataFrame.fillna(pd.DataFrame.mean()) </span><br><span class="line"><span class="comment">#该方法用于将DataFrame数值类型的列的缺省值设为平均值</span></span><br><span class="line">pd.ge_dummies(pd.DataFrame, dummy_nan=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#用于将DataFrame的非数值列转为one-hot向量</span></span><br><span class="line">pd.DataFrame.to_numpy(dtype=<span class="built_in">float</span>)</span><br><span class="line"><span class="comment">#将entry都为数值型的DataFrame转为numpy，后续可转为Tensor</span></span><br></pre></td></tr></table></figure>
<h2 id="pytorch基本操作"><a href="#pytorch基本操作" class="headerlink" title="pytorch基本操作"></a>pytorch基本操作</h2><p>线性代数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment">#用于返回torch.Tensor对象在各个维度的长度,以下两种方式等价</span></span><br><span class="line">torch.Tensor.size()</span><br><span class="line">torch.Tensor.shape</span><br><span class="line"><span class="comment"># torch.Tensor类对象的一些方法可以指定特定维降维,sum()、mean()等</span></span><br><span class="line">torch.Tensor.<span class="built_in">sum</span>(axis=<span class="number">0</span>)<span class="comment">#在0维的方向上求和，张量的0维度消失</span></span><br><span class="line">torch.Tensor.<span class="built_in">sum</span>(axis=<span class="number">0</span>, keepdims=<span class="literal">True</span>) <span class="comment">#张量的0维度保持，长度变为1</span></span><br><span class="line"><span class="comment"># 矩阵乘法</span></span><br><span class="line">torch.dot(·,·) <span class="comment">#用于两个一维向量点积</span></span><br><span class="line">torch.Tensor.dot(·)</span><br><span class="line">torch.mv() <span class="comment">#用于矩阵向量积,矩阵列维度必须等于向量长度</span></span><br><span class="line">torch.mm() <span class="comment">#用于矩阵乘法</span></span><br></pre></td></tr></table></figure>
<p>matplotlib.pyplot中的图形对象和子图对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">fig = plt.figure()</span><br><span class="line"><span class="comment"># 图形是顶层容器,管理整个绘图区域，可以有多个子图</span></span><br><span class="line">ax = fig.add_subplot()</span><br><span class="line"><span class="comment"># 添加子图对象</span></span><br><span class="line">ax.plot(y)</span><br><span class="line"><span class="comment"># 在子图上画图,若只指定一个列表，则默认索引位横坐标</span></span><br><span class="line">fig, (ax1, ax2) = plt.subplots(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 可以同时创建图形和子图对象</span></span><br><span class="line">plt.gca() <span class="comment"># 返回当前正在操作的子图对象</span></span><br></pre></td></tr></table></figure>
<p>自动微分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># 为Tensor对象分配梯度储存空间</span></span><br><span class="line">torch.Tensor.requires_grad_(<span class="literal">True</span>)</span><br><span class="line">torch.arange(<span class="number">4.0</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 反向传播</span></span><br><span class="line">y.backward() <span class="comment"># y需要是一个标量</span></span><br><span class="line">y.backward(torch.ones_like(y)) <span class="comment"># 当y是一个张量时,先将y与参数点乘,再做反向传播</span></span><br><span class="line">torch.Tensor.grad <span class="comment"># Tensor类对象中的该属性记录了y关于该Tensor的梯度</span></span><br><span class="line">torch.Tensor.grad.zero_() <span class="comment"># 将梯度值清零</span></span><br><span class="line"><span class="comment"># 分离计算</span></span><br><span class="line">u = y.detach() <span class="comment"># u是一个值为tensor的对象,不参与计算图</span></span><br><span class="line"><span class="comment"># 注意,默认backward()后会清空计算图中间变量(前向传播时生成),可以使用下面的方法保存,以进行多次梯度反向传播</span></span><br><span class="line">y.backward(retain_graph=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建计算图需要经过python控制流,依然可以得到变量的梯度。</span></span><br></pre></td></tr></table></figure>
<p>查看pytorch帮助文档</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="built_in">dir</span>(torch.distributons)</span><br><span class="line"><span class="built_in">help</span>(torch.ones)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.hackerzzp.top/2023/11/13/Personalized-Federated-Learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://gips2.baidu.com/it/u=3498797510,1741357035&fm=3039&app=3039&f=JPEG?w=1024&h=1024">
      <meta itemprop="name" content="Zp Zeng">
      <meta itemprop="description" content="HelloWorldMan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZpZeng's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/13/Personalized-Federated-Learning/" class="post-title-link" itemprop="url">Personalized Federated Learning</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-13 00:34:15" itemprop="dateCreated datePublished" datetime="2023-11-13T00:34:15+08:00">2023-11-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-14 09:22:53" itemprop="dateModified" datetime="2023-11-14T09:22:53+08:00">2023-11-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Towards-Personalized-Federated-Learning"><a href="#Towards-Personalized-Federated-Learning" class="headerlink" title="Towards Personalized Federated Learning"></a>Towards Personalized Federated Learning</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="Categorization-of-FL"><a href="#Categorization-of-FL" class="headerlink" title="Categorization of  FL"></a>Categorization of  FL</h3><ol>
<li>HFL: participants share the same feature space but have different data samples</li>
<li>VFL: participants have overlapping data samples but differ in the feature space</li>
<li>FTL: participants have little overlap in both the feature space and the sample space</li>
</ol>
<h3 id="Motivation-for-Personalized-Federated-Learning"><a href="#Motivation-for-Personalized-Federated-Learning" class="headerlink" title="Motivation for Personalized Federated Learning"></a>Motivation for Personalized Federated Learning</h3><p>To solve two challenges:</p>
<ol>
<li>poor convergence on highly heterogeneous data<ul>
<li>client drift on non-IID data</li>
<li><img src="/2023/11/13/Personalized-Federated-Learning/PFL_clientDrift.png" alt></li>
</ul>
</li>
<li>lack of solution personalization<ul>
<li>the single-globally shared model will not generalize well for a local distribution that is very different from the global distribution</li>
</ul>
</li>
</ol>
<h2 id="Strategies-for-personalized-federated-learning"><a href="#Strategies-for-personalized-federated-learning" class="headerlink" title="Strategies for personalized federated learning"></a>Strategies for personalized federated learning</h2><h3 id="Strategy-Ⅰ-Global-Model-Personalization"><a href="#Strategy-Ⅰ-Global-Model-Personalization" class="headerlink" title="Strategy Ⅰ : Global Model Personalization"></a>Strategy Ⅰ : Global Model Personalization</h3><p>FL training + local adaption</p>
<ol>
<li>follows the general FL training procedure to train a single-global FL model</li>
<li>personalized through a local adaption involves additional training on each local dataset</li>
</ol>
<p>personalization performance directly depends on the generalization performance of global model</p>
<p>Personalization techniques</p>
<ol>
<li>data-based approaches<ul>
<li>reduce the statistical heterogeneity among the clients’ datasets</li>
</ul>
</li>
<li>model-based approaches<ul>
<li>learn a strong global model for future personalization on individual clients</li>
</ul>
</li>
</ol>
<h3 id="Strategy-Ⅱ-Learning-Personalized-Models"><a href="#Strategy-Ⅱ-Learning-Personalized-Models" class="headerlink" title="Strategy Ⅱ : Learning Personalized Models"></a>Strategy Ⅱ : Learning Personalized Models</h3><p>to build personalized models by modifying the FL model aggregation process</p>
<p>Personalized techniques</p>
<ol>
<li>architecture-based approaches<ul>
<li>provide a personalized model architecture tailored to each client</li>
</ul>
</li>
<li>similarity-based approaches<ul>
<li>leverage client relationships to improve personalized model performance where similar personalized models are built for related clients.</li>
</ul>
</li>
</ol>
<p>the optimization objective is formulated differently from the vanilla FL setting</p>
<h2 id="Strategy-Ⅰ-Global-Model-Personalization-1"><a href="#Strategy-Ⅰ-Global-Model-Personalization-1" class="headerlink" title="Strategy Ⅰ:   Global Model Personalization"></a>Strategy Ⅰ:   Global Model Personalization</h2><h3 id="Data-Based-Approaches"><a href="#Data-Based-Approaches" class="headerlink" title="Data-Based Approaches"></a>Data-Based Approaches</h3><ol>
<li>Data Augmentation<ul>
<li>data sharing: distributes a small amount of global data balanced by classes to each client</li>
<li>FAug: training a GAN in FL server with some data samples of the minority classes</li>
<li>self-balancing FL: The FL server requires statistical information about clients’ local data distributions</li>
<li>FedHome: trains a generative convolutional autoencoder (GCAE) model. </li>
</ul>
</li>
<li>Client Selection<ul>
<li>FAVOR: selects a subset of participating clients for each training round in order to mitigate the bias introduced by non-IID data</li>
<li>tier-based FL system (TiFL): groups clients into tiers based on training performance, adaptively selects participating clients from the same tier for each training round</li>
<li>FedSAE: a self-adaptive FL system that adaptively selects clients with larger local training loss </li>
</ul>
</li>
</ol>
<p>need to modify the local data distributions, which may result in the loss of valuable information associated with the inherent diversity of client behaviors.</p>
<h3 id="Model-Based-Approaches"><a href="#Model-Based-Approaches" class="headerlink" title="Model-Based  Approaches"></a>Model-Based  Approaches</h3><ol>
<li><p>Regularized Local Loss: </p>
<script type="math/tex; mode=display">
\min_{\theta \in \mathbb{R}^d} h_c(\theta ; \omega) \triangleq f_c(\theta) + l_{reg}(\theta; \omega)</script></li>
<li><p>Between Global and Local Models</p>
<ul>
<li>FedProx: introduced a proximal term to the local subproblem which considers the dissimilarity between the global FL model and local models to adjust the impact of local updates</li>
<li>FedCL: estimate the importance of the weights to the global model, penalization steps are carried out to prevent important parameters of the global model from being changed when adapting the global model to clients’ local data.</li>
<li>SCAFFOLD: uses variance reduction to alleviate the effect of client drifting, </li>
</ul>
</li>
<li><p>Between Historical Local Model Snapshots</p>
<ul>
<li><p>MOON: reduce the distance between the representations learned by the local models and the global model (i.e., to alleviate weight divergence), increase the distance between the representations learned between a given local model and its previous local model (i.e., to speed up convergence).</p>
</li>
<li><p>Meta-learning(Per-FedAvg): </p>
<script type="math/tex; mode=display">
\min_{\omega \in \mathbb{R}^b} F(\omega) \triangleq \frac{1}{C} \sum_{c=1}^{C} f_c(\omega - \alpha \nabla f_c(\omega))</script><p>the new goal is transformed to learn a good initial global model that performs well on a new heterogeneous task after it is updated with a few steps of gradient descent</p>
</li>
<li><p>Transfer learning: TL is first carried out using a model pretrained on a public dataset. Each client then fine-tunes this model on its private data.  </p>
<p>improves personalization by reducing the domain discrepancy between the global and local models.</p>
</li>
</ul>
</li>
</ol>
<h3 id="Summary-of-Personalization-Techniques-in-Global-Model-Personalization"><a href="#Summary-of-Personalization-Techniques-in-Global-Model-Personalization" class="headerlink" title="Summary of Personalization Techniques in Global Model Personalization"></a>Summary of Personalization Techniques in Global Model Personalization</h3><p><img src="/2023/11/13/Personalized-Federated-Learning/summary of personalization techniques in Global Model Personalization .png" alt></p>
<h2 id="Strategy-II-Learning-Personalized-Models"><a href="#Strategy-II-Learning-Personalized-Models" class="headerlink" title="Strategy II: Learning Personalized Models"></a>Strategy II: Learning Personalized Models</h2><h3 id="Architecture-Based-Approaches"><a href="#Architecture-Based-Approaches" class="headerlink" title="Architecture-Based Approaches"></a>Architecture-Based Approaches</h3><ol>
<li>Parameter Decoupling<ul>
<li>decoupling the local private model parameters from the global FL model parameters. Private parameters are trained locally on the clients and not shared with the FL server<ul>
<li>a “base layers + personalized layers” design</li>
<li>personalized feature representations for each client</li>
</ul>
</li>
</ul>
</li>
<li>Knowledge Distillation<ul>
<li>Knowledge is commonly represented as class scores or logit outputs in existing FL distillation approaches.</li>
<li>FedMD: <ul>
<li>Learning occurs through a consensus computed using the average class scores on a public dataset.</li>
<li>each client trains its model using the public dataset based on the updated consensus and fine-tunes its model on its private dataset thereafter</li>
</ul>
</li>
<li>FedGen:<ul>
<li>A generative model is trained in the FL server and broadcast to the clients. Each client then generates augmented representations over the feature space</li>
</ul>
</li>
<li>FedDF:<ul>
<li>FL server constructs <em>p</em> distinct prototype models, each representing clients with identical model architectures</li>
<li>Cross-architecture learning is then performed via ensemble distillation</li>
</ul>
</li>
<li>group knowledge transfer (FedGKT)<ul>
<li>uses alternating minimization to train small edge models and a large server model through a bidirectional distillation approach</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Similarity-Based-Approaches"><a href="#Similarity-Based-Approaches" class="headerlink" title="Similarity-Based Approaches"></a>Similarity-Based Approaches</h3><ol>
<li><p>Multitask Learning</p>
<ul>
<li><p>FedAMP: an attention-based mechanism that enforces stronger pairwise collaboration amongst FL clients with similar data distributions</p>
<ul>
<li><p>maintains a personalized cloud model u_c for each client in the server</p>
</li>
<li><script type="math/tex; mode=display">
u_c = \xi_{c,1} \theta_1 + \cdots + \xi_{c,m}\theta_m , \quad \sum_{m \in C} \xi_{c, m} = 1</script></li>
<li><p>local loss function:</p>
<ul>
<li><script type="math/tex; mode=display">
\theta^*_{c} = {\text{arg} \min }_{\theta \in \mathbb{R}^d} f_c(\theta) + \frac{\mu}{2\alpha}\| \theta - u_c\|^2</script></li>
</ul>
</li>
</ul>
</li>
<li><p>FedCurv:  Parameter importance is estimated using the Fisher information matrix and penalization steps are carried out to preserve important parameters</p>
</li>
</ul>
</li>
<li><p>Model Interpolation: </p>
<ul>
<li>Each FL client learns an individual local model. A penalty parameter <em>λ</em> is used to discourage the local models from being too dissimilar from the mean model</li>
<li>APFL: finding the optimal combination of global and local models in a communication-efficient manner.</li>
<li>HeteroFL: trains local models with diverse computational complexities, based on a single-global model</li>
</ul>
</li>
<li><p>Clustering:</p>
<ul>
<li><p>the cosine similarity of the gradient updates from the clients is used to divide the FL clients into clusters.</p>
</li>
<li><p>iterative federated clustering algorithm (IFCA): </p>
<ul>
<li>server constructs K global models and broadcasts these models to all clients for local loss computation. Each client is assigned to one of the K clusters the global model of which achieves the lowest loss value on the client’s data</li>
</ul>
</li>
<li><p>community-based FL (CBFL):</p>
<ul>
<li>K-means clustering with a predetermined number of clusters to cluster patients based on the encoded features of their private data</li>
</ul>
</li>
<li><p>FedGroup:</p>
<ul>
<li>performs clustering on the local client updates using the K-means++ algorithm based on the Euclidean distance of the decomposed cosine similarity (EDC).</li>
</ul>
</li>
<li><p>multicenter formulation:</p>
<ul>
<li><p>loss function: </p>
<script type="math/tex; mode=display">
l = \frac{1}{C} = \sum_{k=1}^{K}\sum_{c=1}^{C} r_c^{(k)} \text{Dist}(\theta_c, \omega^{(k)}), \quad r_c^{(k)} = \left\{
    \begin{aligned}
    0, \quad c \notin \text{cluster}_k\\
    1, \quad c \in \text{cluster}_k\\
    \end{aligned}
    \right
    .</script></li>
<li><p>EM algorithm to solve</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><img src="/2023/11/13/Personalized-Federated-Learning/summary for strategy2.png" alt></p>
<h2 id="PFL-Benchmark-and-Evaluation-Metrics"><a href="#PFL-Benchmark-and-Evaluation-Metrics" class="headerlink" title="PFL Benchmark and Evaluation Metrics"></a>PFL Benchmark and Evaluation Metrics</h2><h3 id="FL-Benchmark-Datasets"><a href="#FL-Benchmark-Datasets" class="headerlink" title="FL Benchmark Datasets"></a>FL Benchmark Datasets</h3><h3 id="PFL-Experimental-Evaluation-Design"><a href="#PFL-Experimental-Evaluation-Design" class="headerlink" title="PFL Experimental Evaluation Design"></a>PFL Experimental Evaluation Design</h3><ol>
<li><em>Quantity Skew:</em> FL clients hold local datasets of different sizes, with some clients having considerably larger amounts of data than others</li>
<li><em>Feature Distribution Skew:</em> The feature distribution Pc(x) varies across clients, while the conditional distribution P(y|x) is the same across clients.</li>
<li><em>Label Distribution Skew:</em> The label distribution Pc(y) varies across clients, while the conditional distribution P(x|y) is the same across clients.</li>
<li><em>Label Preference Skew:</em> The conditional distribution Pc(x<em>|</em>y) varies across clients, while the label distribution P(y) is the same across clients.</li>
</ol>
<h3 id="PFL-Evaluation-Metrics"><a href="#PFL-Evaluation-Metrics" class="headerlink" title="PFL Evaluation Metrics"></a>PFL Evaluation Metrics</h3><ol>
<li>Model performance can be measured in terms of accuracy and convergence.</li>
<li>System performance metrics focus on communication efficiency, computational efficiency, system heterogeneity, system scalability, and fault tolerance.</li>
<li>Trustworthy AI metrics</li>
</ol>
<h2 id="Promising-Future-Research-Directions"><a href="#Promising-Future-Research-Directions" class="headerlink" title="Promising Future Research Directions"></a>Promising Future Research Directions</h2><h3 id="Opportunities-for-PFL-Architectural-Design"><a href="#Opportunities-for-PFL-Architectural-Design" class="headerlink" title="Opportunities for PFL Architectural Design"></a>Opportunities for PFL Architectural Design</h3><ol>
<li>Client Data Heterogeneity Analytics</li>
<li>Aggregation Procedure</li>
<li>PFL Architecture Search</li>
<li>Spatial Adaptability: refers to the ability of PFL systems to handle variations across client datasets</li>
<li>Temporal Adaptability: refers to the ability of a PFL system to learn from nonstationary data</li>
</ol>
<h3 id="Opportunities-for-PFL-Benchmarking"><a href="#Opportunities-for-PFL-Benchmarking" class="headerlink" title="Opportunities for PFL Benchmarking"></a>Opportunities for PFL Benchmarking</h3><ol>
<li>Realistic Datasets</li>
<li>Realistic Non-IID Settings</li>
<li>Holistic Evaluation Metrics</li>
<li>Opportunities for Trustworthy PFL</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.hackerzzp.top/2023/11/10/%E5%9F%BA%E4%BA%8Edocker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://gips2.baidu.com/it/u=3498797510,1741357035&fm=3039&app=3039&f=JPEG?w=1024&h=1024">
      <meta itemprop="name" content="Zp Zeng">
      <meta itemprop="description" content="HelloWorldMan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZpZeng's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/10/%E5%9F%BA%E4%BA%8Edocker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">基于docker容器的前后端一键部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-11-10 15:17:04 / 修改时间：17:30:58" itemprop="dateCreated datePublished" datetime="2023-11-10T15:17:04+08:00">2023-11-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">软件工程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基于docker容器进行服务器一键部署"><a href="#基于docker容器进行服务器一键部署" class="headerlink" title="基于docker容器进行服务器一键部署"></a>基于docker容器进行服务器一键部署</h1><p>[TOC]</p>
<h2 id="项目目录结构"><a href="#项目目录结构" class="headerlink" title="项目目录结构"></a>项目目录结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--rbac_admin (总目录)</span><br><span class="line">	--RBAC-server 后端项目文件夹(基于springboot)</span><br><span class="line">		--...(springboot项目文件)</span><br><span class="line">			注意：pom.xml中配置&lt;repositories&gt;仓库镜像、以及&lt;build&gt;下的&lt;filename&gt;maven编译的jar包名</span><br><span class="line">				/src/main/resources/application.yaml配置中不需要配置数据库源，在docker-compose中配置</span><br><span class="line">		--Dockerfile  docker后端容器镜像配置——Java运行时环境+后端jar包</span><br><span class="line">	--RBAC-web  前端项目文件夹(基于vue)</span><br><span class="line">		--...(vue项目文件)</span><br><span class="line">		--.npmrc 用于配置npm下载包的仓库镜像</span><br><span class="line">		--nginx.conf 用于配置nginx容器: 监听端口、反向代理</span><br><span class="line">		--Dockerfile docker前端容器镜像配置</span><br><span class="line">			——node运行环境+npm run build vue项目 ; =&gt; 生成一个html静态文件</span><br><span class="line">			——nginx镜像，导入了上述html静态文件以及nginx.conf</span><br><span class="line">	--sql  </span><br><span class="line">		--RBAC_database_init.sql 数据库初始化配置文件</span><br><span class="line">	--docker-compose.yml   docker-compose配置文件，运行多容器服务</span><br><span class="line">	--deploy.sh    bash文件，用于服务器自动化部署</span><br></pre></td></tr></table></figure>
<h2 id="实现一键部署的bash脚本——deploy-sh"><a href="#实现一键部署的bash脚本——deploy-sh" class="headerlink" title="实现一键部署的bash脚本——deploy.sh"></a>实现一键部署的bash脚本——deploy.sh</h2><ol>
<li><h3 id="bash脚本基础设置"><a href="#bash脚本基础设置" class="headerlink" title="bash脚本基础设置"></a>bash脚本基础设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;开始部署......&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当任何一个命令返回非零值时，退出脚本</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义颜色</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># 无颜色</span></span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="检查docker是否安装"><a href="#检查docker是否安装" class="headerlink" title="检查docker是否安装"></a>检查docker是否安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查docker命令是否可用</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v docker &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>docker 命令未找到，请先安装 Docker。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;检查docker命令是否可用......<span class="variable">$&#123;GREEN&#125;</span>通过<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查docker-compose命令是否可用</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v docker-compose &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>docker-compose 命令未找到，请先安装 Docker Compose。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;检查docker-compose 命令......<span class="variable">$&#123;GREEN&#125;</span>通过<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="创建maven缓存的docker-volume"><a href="#创建maven缓存的docker-volume" class="headerlink" title="创建maven缓存的docker volume"></a>创建maven缓存的docker volume</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 Maven 缓存 volume 是否已经存在</span></span><br><span class="line"><span class="keyword">if</span> docker volume inspect rbac-maven-repo &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>Maven 缓存 volume 已存在。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>创建 Maven 缓存 volume...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    docker volume create --name rbac-maven-repo</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="通过容器构建jar包-springboot项目的可运行jar包"><a href="#通过容器构建jar包-springboot项目的可运行jar包" class="headerlink" title="通过容器构建jar包(springboot项目的可运行jar包)"></a>通过容器构建jar包(springboot项目的可运行jar包)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过容器构建 jar 包</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;开始构建 jar 包...&quot;</span></span><br><span class="line"></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --name rbac-maven \</span><br><span class="line">	<span class="comment">#--rm表示该容器用后即删</span></span><br><span class="line">    -v rbac-maven-repo:/root/.m2 \</span><br><span class="line">    <span class="comment">#-v用于将上面创建的volume挂载到临时maven容器中，使maven缓存能一直存在，不需要每次下载。</span></span><br><span class="line">    -v <span class="string">&quot;<span class="variable">$PWD</span>/RBAC-server&quot;</span>:/usr/src/mymaven \</span><br><span class="line">    <span class="comment">#-v用于将宿主机上的springboot后端服务器源代码挂载到临时maven容器中，进行打包</span></span><br><span class="line">    -w /usr/src/mymaven \</span><br><span class="line">    <span class="comment">#-w指定容器启动时执行的命令的工作目录。</span></span><br><span class="line">    maven:3.8.4-jdk-8 mvn clean install package -e <span class="string">&#x27;-Dmaven.test.skip=true&#x27;</span> || &#123; <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>构建 jar 包失败。<span class="variable">$&#123;NC&#125;</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="comment">#maven:3.8.4-jdk-8表示用于构建maven容器的镜像</span></span><br><span class="line">    <span class="comment">#mvn clean install package -e &#x27;-Dmaven.test.skip=true&#x27;代表容器启动时执行的命令，构建jar包(跳过测试)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;通过容器构建 jar 包......<span class="variable">$&#123;GREEN&#125;</span>通过<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>注意，docker -v挂载宿主机目录到容器中之后，两个目录的内容是同步的，所以maven生成的jar包在宿主机的target文件夹下存在。</p>
</li>
<li><h3 id="docker-compose-build-构建镜像"><a href="#docker-compose-build-构建镜像" class="headerlink" title="docker-compose build 构建镜像"></a>docker-compose build 构建镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;开始构建镜像...&quot;</span></span><br><span class="line">docker-compose build --no-cache || &#123; <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>构建 Docker 镜像失败。<span class="variable">$&#123;NC&#125;</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;构建 Docker 镜像......<span class="variable">$&#123;GREEN&#125;</span>通过<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="检查是否有正在运行的docker-compose服务"><a href="#检查是否有正在运行的docker-compose服务" class="headerlink" title="检查是否有正在运行的docker-compose服务"></a>检查是否有正在运行的docker-compose服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;检查是否有正在运行的服务...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否有正在运行的 docker-compose 服务</span></span><br><span class="line"><span class="keyword">if</span> docker-compose ps | grep <span class="string">&quot;ssadmin&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>停止正在运行的服务...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    docker-compose down || &#123; <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>停止服务失败。<span class="variable">$&#123;NC&#125;</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>服务已成功停止。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>没有找到正在运行的服务。<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="docker-compose启动多容器服务"><a href="#docker-compose启动多容器服务" class="headerlink" title="docker-compose启动多容器服务"></a>docker-compose启动多容器服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;启动新服务...&quot;</span></span><br><span class="line"></span><br><span class="line">docker-compose up -d || &#123; <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>启动服务失败。<span class="variable">$&#123;NC&#125;</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>恭喜你！系统部署完成！<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********************************&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;***  Admin UI: http://hostname ***&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;**********************************&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Docker容器及镜像配置"><a href="#Docker容器及镜像配置" class="headerlink" title="Docker容器及镜像配置"></a>Docker容器及镜像配置</h2><h3 id="后端容器镜像配置——Dockerfile"><a href="#后端容器镜像配置——Dockerfile" class="headerlink" title="后端容器镜像配置——Dockerfile"></a>后端容器镜像配置——Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">8</span>-jre</span><br><span class="line"><span class="comment">## 指定基础镜像——Java8运行时环境</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /RBAC-server</span></span><br><span class="line"><span class="comment">## RUN用于在镜像构建过程中执行命令，此处在容器内部创建了一个目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /RBAC-server</span></span><br><span class="line"><span class="comment">## 设置工作目录</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./target/RBAC-admin.jar app.jar</span></span><br><span class="line"><span class="comment">## 将Jar 文件复制到镜像中，此时已经用临时的maven容器编译好了jar文件(在deploy.sh文件中)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置 TZ 时区</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置 JAVA_OPTS 环境变量，可通过 docker run -e &quot;JAVA_OPTS=&quot; 进行覆盖，指定JVM参数、系统属性</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms512m -Xmx512m -Djava.security.egd=file:/dev/./urandom&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 应用程序参数，在利用该镜像构建容器时，该参数可以指定后端容器的数据库源(见下方CMD命令)</span></span><br><span class="line"><span class="keyword">ENV</span> ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">28080</span></span><br><span class="line"><span class="comment">## 容器暴露的接口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 用该镜像启动容器时，会执行的指令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> java <span class="variable">$&#123;JAVA_OPTS&#125;</span> -jar app.jar <span class="variable">$ARGS</span></span></span><br></pre></td></tr></table></figure>
<h3 id="前端容器镜像配置——Dockerfile"><a href="#前端容器镜像配置——Dockerfile" class="headerlink" title="前端容器镜像配置——Dockerfile"></a>前端容器镜像配置——Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 多阶段构建镜像，最终生成的镜像只包含最终一个阶段的构建结果，不包含之前阶段的镜像——作为临时容器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第一阶段，生成临时容器</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine as build-stage</span><br><span class="line"><span class="comment">## 指定node.js运行环境作为基础镜像，该镜像生成的容器是临时的，用来运行vue项目编译生成html静态文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /admim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> .npmrc package.json package-lock.json ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install --frozen-lockfile</span></span><br><span class="line"><span class="comment">## 用npm安装依赖的包，并锁定包的版本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">ARG</span> NODE_ENV=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">env</span> <span class="variable">$&#123;NODE_ENV&#125;</span> npm run build</span></span><br><span class="line"><span class="comment">## 编译vue项目</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二阶段，nginx镜像，最终用于运行服务器前端，以及反向代理</span></span><br><span class="line"><span class="comment">## -- nginx --</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:alpine</span><br><span class="line"><span class="comment">## 指定基础镜像</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./nginx.conf /etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="comment">## nginx配置文件复制到容器中</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build-stage /admim/dist /usr/share/nginx/html</span></span><br><span class="line"><span class="comment">## 将前一阶段编译得到的html静态文件复制到容器中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="comment">## 指定容器暴露的接口</span></span><br></pre></td></tr></table></figure>
<h3 id="前端nginx配置文件"><a href="#前端nginx配置文件" class="headerlink" title="前端nginx配置文件"></a>前端nginx配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;  ##默认监听宿主机80端口</span><br><span class="line">    server_name  _; ## 重要！！！修改成你的外网 IP/域名</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash"><span class="comment"># 配置gzip压缩</span></span></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;     # 设置允许压缩的页面最小字节数</span><br><span class="line">    gzip_buffers 4 16k;     # 用来存储 gzip 的压缩结果</span><br><span class="line">    gzip_http_version 1.1;  # 识别 HTTP 协议版本</span><br><span class="line">    gzip_comp_level 2;      # 设置 gzip 的压缩比 1-9。1 压缩比最小但最快，而 9 相反</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css application/xml application/javascript; # 指定压缩类型</span><br><span class="line">    gzip_proxied any;       # 无论后端服务器的 headers 头返回什么信息，都无条件启用压缩</span><br><span class="line"></span><br><span class="line">    location / &#123; ## 前端项目，访问该服务器默认代理到前端页面</span><br><span class="line">        root   /usr/share/nginx/html/;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /api/ &#123; ## 后端项目 - 管理后台，后端项目反向代理，前端通过/api/访问后端</span><br><span class="line">        proxy_pass http://rbac-server:28080/; ## 重要！！！proxy_pass 需要设置为后端项目所在服务器的 IP</span><br><span class="line">        ## 前后端通过docker-compose运行多容器服务，自动在同一网络中，可以用容器名互相访问</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="docker-compose-yml配置文件"><a href="#docker-compose-yml配置文件" class="headerlink" title="docker-compose.yml配置文件"></a>docker-compose.yml配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3.4&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    container_name: rbac-mysql</span><br><span class="line">    image: mysql:8</span><br><span class="line">    ## 使用docker-hub提供的镜像构建数据库容器</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    tty: true</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3306:3306&quot;</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_DATABASE: $&#123;MYSQL_DATABASE:-root&#125;</span><br><span class="line">      MYSQL_ROOT_PASSWORD: $&#123;MYSQL_ROOT_PASSWORD:-zzp123456&#125;</span><br><span class="line">      ## 利用环境变量设置数据库的用户名和密码</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql:/var/lib/mysql/</span><br><span class="line">      - ./sql/RABC_database_init.sql:/docker-entrypoint-initdb.d/ssadmin_init.sql:ro</span><br><span class="line">      ## 将数据库挂载到宿主机，并且把sql初始化文件挂载到数据库容器的初始化目录下</span><br><span class="line">  </span><br><span class="line">  redis:</span><br><span class="line">    container_name: rbac-redis</span><br><span class="line">    image: redis:6-alpine</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - redis:/data</span><br><span class="line"></span><br><span class="line">  server:</span><br><span class="line">    container_name: rbac-server</span><br><span class="line">    build:</span><br><span class="line">      context: ./RBAC-server/</span><br><span class="line">      ## 利用build使用Dockerfile文件构建镜像</span><br><span class="line">    image: rbac-server</span><br><span class="line">    ## 为构建的镜像命名，不能有大写字母</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;28080:28080&quot;</span><br><span class="line">    environment:</span><br><span class="line">      SPRING_PROFILES_ACTIVE: local</span><br><span class="line">      JAVA_OPTS:</span><br><span class="line">        $&#123;JAVA_OPTS:-</span><br><span class="line">          -Xms512m</span><br><span class="line">          -Xmx512m</span><br><span class="line">          -Djava.security.egd=file:/dev/./urandom</span><br><span class="line">        &#125;</span><br><span class="line">      ARGS:</span><br><span class="line">        --spring.datasource.url=$&#123;DATASOURCE_URL:-jdbc:mysql://rbac-mysql:3306/RABC_database?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;allowPublicKeyRetrieval=true&amp;nullCatalogMeansCurrent=true&#125;</span><br><span class="line">        --spring.datasource.username=$&#123;DATASOURCE_USERNAME:-root&#125;</span><br><span class="line">        --spring.datasource.password=$&#123;DATASOURCE_PASSWORD:-zzp123456&#125;</span><br><span class="line">        --spring.redis.host=$&#123;REDIS_HOST:-rbac-redis&#125;</span><br><span class="line">        ## 启动容器时利用环境变量传入参数，连接数据库源(和Dockerfile中对应)</span><br><span class="line">        ## 这些参数在Dockerfile中也被定义</span><br><span class="line">    depends_on:</span><br><span class="line">    ## 依赖的容器</span><br><span class="line">      - mysql</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    container_name: rbac-web</span><br><span class="line">    build:</span><br><span class="line">      context: ./RBAC-web</span><br><span class="line">      args:</span><br><span class="line">        NODE_ENV:</span><br><span class="line">          ENV=$&#123;NODE_ENV:-production&#125;</span><br><span class="line">          VUE_APP_TITLE=$&#123;VUE_APP_TITLE:-RBAC管理系统&#125;</span><br><span class="line">    image: rbac-web</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - server</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql:</span><br><span class="line">    driver: local</span><br><span class="line">  redis:</span><br><span class="line">    driver: local</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zp Zeng"
      src="https://gips2.baidu.com/it/u=3498797510,1741357035&fm=3039&app=3039&f=JPEG?w=1024&h=1024">
  <p class="site-author-name" itemprop="name">Zp Zeng</p>
  <div class="site-description" itemprop="description">HelloWorldMan</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/epiphanyer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;epiphanyer" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:aristo.fdu@gmail.com" title="E-Mail → mailto:aristo.fdu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zp Zeng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>
<script type="text/javascript" src="/js/click_love.js"></script>



        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="true"></script>


  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
